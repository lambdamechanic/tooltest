#!/usr/bin/env sh

set -u

if [ "${BR_BEADS_SYNC_MAINTENANCE:-}" = "1" ]; then
    exit 0
fi

changed=0
if [ "$#" -ge 2 ]; then
    if git diff --name-only "$1" "$2" -- .beads/issues.jsonl | grep -q .; then
        changed=1
    fi
else
    if git rev-parse -q --verify HEAD@{1} >/dev/null 2>&1; then
        if git diff --name-only HEAD@{1} HEAD -- .beads/issues.jsonl | grep -q .; then
            changed=1
        fi
    fi
fi

if [ "$changed" -eq 0 ]; then
    exit 0
fi

if ! command -v br >/dev/null 2>&1; then
    echo "Warning: br command not found; skipping post-checkout import." >&2
    echo "  Run 'br sync --import-only' manually once br is available." >&2
    exit 0
fi

if ! br sync --import-only; then
    echo "Warning: br sync --import-only failed after checkout." >&2
    echo "  Run 'br sync --import-only' manually to recover." >&2
    exit 0
fi
