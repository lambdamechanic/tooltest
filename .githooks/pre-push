#!/usr/bin/env sh

set -u

if [ "${BR_BEADS_SYNC_MAINTENANCE:-}" = "1" ]; then
    exit 0
fi

remote_name=${1:-}
if [ -z "$remote_name" ]; then
    echo "Error: pre-push requires a remote name." >&2
    exit 1
fi

if ! command -v br >/dev/null 2>&1; then
    echo "Error: br command not found in PATH; pre-push requires br." >&2
    echo "  Install br or add it to your PATH before pushing." >&2
    exit 1
fi

if ! br sync --flush-only; then
    echo "Error: br sync --flush-only failed; aborting push." >&2
    exit 1
fi

if ! git diff --quiet -- .beads/issues.jsonl; then
    echo "Error: .beads/issues.jsonl has uncommitted changes after flush." >&2
    echo "  Commit .beads/issues.jsonl before pushing." >&2
    exit 1
fi

if ! git diff --cached --quiet -- .beads/issues.jsonl; then
    echo "Error: .beads/issues.jsonl is staged but not committed." >&2
    echo "  Commit .beads/issues.jsonl before pushing." >&2
    exit 1
fi

beads_worktree=".git/beads-worktrees/beads-sync"

ensure_beads_branch() {
    if git show-ref --verify --quiet refs/heads/beads-sync; then
        return 0
    fi

    if git fetch "$remote_name" beads-sync:beads-sync >/dev/null 2>&1; then
        return 0
    fi

    git branch beads-sync HEAD >/dev/null 2>&1
}

ensure_beads_worktree() {
    if [ -e "$beads_worktree/.git" ]; then
        return 0
    fi

    if ! ensure_beads_branch; then
        return 1
    fi

    if ! git worktree add --no-checkout "$beads_worktree" beads-sync >/dev/null 2>&1; then
        return 1
    fi

    BR_BEADS_SYNC_MAINTENANCE=1 git -C "$beads_worktree" sparse-checkout init --cone >/dev/null 2>&1
    BR_BEADS_SYNC_MAINTENANCE=1 git -C "$beads_worktree" sparse-checkout set /.beads >/dev/null 2>&1
    BR_BEADS_SYNC_MAINTENANCE=1 git -C "$beads_worktree" checkout beads-sync >/dev/null 2>&1
}

if ! ensure_beads_worktree; then
    echo "Error: failed to create beads-sync worktree at $beads_worktree." >&2
    exit 1
fi

if ! BR_BEADS_SYNC_MAINTENANCE=1 git -C "$beads_worktree" checkout beads-sync >/dev/null 2>&1; then
    if ! BR_BEADS_SYNC_MAINTENANCE=1 git -C "$beads_worktree" checkout -B beads-sync >/dev/null 2>&1; then
        echo "Error: failed to check out beads-sync branch in worktree." >&2
        exit 1
    fi
fi

if ! BR_BEADS_SYNC_MAINTENANCE=1 git -C "$beads_worktree" reset --hard >/dev/null 2>&1; then
    echo "Error: failed to reset beads-sync worktree." >&2
    exit 1
fi

if ! BR_BEADS_SYNC_MAINTENANCE=1 git -C "$beads_worktree" sparse-checkout set /.beads >/dev/null 2>&1; then
    echo "Error: failed to enforce sparse-checkout for beads-sync." >&2
    exit 1
fi

if ! mkdir -p "$beads_worktree/.beads"; then
    echo "Error: failed to ensure $beads_worktree/.beads directory." >&2
    exit 1
fi

if ! git show HEAD:.beads/issues.jsonl > "$beads_worktree/.beads/issues.jsonl"; then
    echo "Error: failed to read .beads/issues.jsonl from HEAD." >&2
    exit 1
fi

BR_BEADS_SYNC_MAINTENANCE=1 git -C "$beads_worktree" add .beads/issues.jsonl >/dev/null 2>&1

if ! git -C "$beads_worktree" diff --cached --quiet -- .beads/issues.jsonl; then
    if ! BR_BEADS_SYNC_MAINTENANCE=1 git -C "$beads_worktree" commit -m "Sync .beads/issues.jsonl" >/dev/null 2>&1; then
        echo "Error: failed to commit .beads/issues.jsonl to beads-sync." >&2
        exit 1
    fi
fi

if ! BR_BEADS_SYNC_MAINTENANCE=1 git -C "$beads_worktree" push "$remote_name" beads-sync >/dev/null 2>&1; then
    echo "Error: failed to push beads-sync to $remote_name." >&2
    exit 1
fi
